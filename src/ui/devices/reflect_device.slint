import { Theme } from "../theme/index.slint";
import { RDSKnob, RDSHeaderLabel, RDSCircleToggle, RDSButton, RDSComboBox } from "../components/index.slint";

/*
Component: ReflectDevice
Description: Reflect (Vast/Space) device inspired by Torso S-4.
Public members:
- reflect-enabled: bool - Device on/off
- reflect-delay: float - Delay amount
- reflect-time: float - Delay time (normalized)
- reflect-time-mode: int - 0 straight, 1 dotted, 2 triplet, 3 free
- reflect-reverb: float - Reverb amount
- reflect-size: float - Reverb size
- reflect-feedback: float - Delay feedback
- reflect-spread: float - Stereo spread
- reflect-damp: float - Damp (LPF)
- reflect-decay: float - Reverb decay
- reflect-post-gain: float - Post gain
- reflect-freeze: bool - Freeze toggle
*/
export component ReflectDevice {
    in-out property <bool> reflect-enabled: false;
    in-out property <float> reflect-delay: 0.0;
    in-out property <float> reflect-time: 0.5;
    in-out property <int> reflect-time-mode: 0;
    in-out property <float> reflect-reverb: 0.0;
    in-out property <float> reflect-size: 0.5;
    in-out property <float> reflect-feedback: 0.0;
    in-out property <float> reflect-spread: 0.0;
    in-out property <float> reflect-damp: 0.5;
    in-out property <float> reflect-decay: 0.5;
    in-out property <float> reflect-post-gain: 0.5;
    in-out property <bool> reflect-freeze: false;

    callback toggle-reflect-enabled();
    callback toggle-reflect-freeze();
    callback reflect-clear();
    callback reflect-delay-changed(value: float);
    callback reflect-time-changed(value: float);
    callback reflect-time-mode-selected(index: int);
    callback reflect-reverb-changed(value: float);
    callback reflect-size-changed(value: float);
    callback reflect-feedback-changed(value: float);
    callback reflect-spread-changed(value: float);
    callback reflect-damp-changed(value: float);
    callback reflect-decay-changed(value: float);
    callback reflect-post-gain-changed(value: float);

    private property <[string]> reflect-time-divisions: [
        "4/1", "2/1", "1/1", "1/2", "1/4", "1/8", "1/16", "1/32", "1/64"
    ];
    private property <[string]> reflect-time-divisions-dotted: [
        "4/1 D", "2/1 D", "1/1 D", "1/2 D", "1/4 D", "1/8 D", "1/16 D", "1/32 D", "1/64 D"
    ];
    private property <[string]> reflect-time-divisions-triplet: [
        "4/1 T", "2/1 T", "1/1 T", "1/2 T", "1/4 T", "1/8 T", "1/16 T", "1/32 T", "1/64 T"
    ];
    private property <int> reflect-time-division-index:
        Math.max(
            0,
            Math.min(
                root.reflect-time-divisions.length - 1,
                Math.round(root.reflect-time * (root.reflect-time-divisions.length - 1))
            )
        );
    private property <[string]> reflect-time-division-model:
        root.reflect-time-mode == 1
            ? root.reflect-time-divisions-dotted
            : (root.reflect-time-mode == 2
                ? root.reflect-time-divisions-triplet
                : (root.reflect-time-mode == 3
                    ? ["Free"]
                    : root.reflect-time-divisions));
    private property <string> reflect-time-division-label:
        root.reflect-time-mode == 1
            ? root.reflect-time-divisions-dotted[root.reflect-time-division-index]
            : (root.reflect-time-mode == 2
                ? root.reflect-time-divisions-triplet[root.reflect-time-division-index]
                : root.reflect-time-divisions[root.reflect-time-division-index]);
    private property <int> reflect-time-division-index-ui:
        root.reflect-time-mode == 3 ? 0 : root.reflect-time-division-index;
    private property <string> reflect-time-readout:
        root.reflect-time-mode == 3
            ? ("Free " + Math.round(2.7 + (10000 - 2.7) * root.reflect-time) + "ms")
            : root.reflect-time-division-label;

    VerticalLayout {
        spacing: 8px;

        RDSHeaderLabel {
            text: "Reflect";
            horizontal-alignment: left;
            padding-horizontal: 12px;
            padding-vertical: 6px;
            right-padding: 12px;
            HorizontalLayout {
                spacing: 6px;
                alignment: center;
                RDSCircleToggle {
                    active: root.reflect-enabled;
                    label: "Bypass";
                    label-active: "On";
                    label-pos: "left";
                    label-color: Theme.active.text_secondary;
                    label-active-color: Theme.active.text_primary;
                    label-font-size: 11px;
                    label-font-weight: 500;
                    clicked => root.toggle-reflect-enabled();
                }
            }
        }

        Rectangle {
            width: 604px;
            background: Theme.active.ui_device_panel_bg;
            border-width: 2px;
            border-radius: 6px;
            border-color: Theme.active.border-strong;
            GridLayout {
                padding-top: 30px;
                padding-right: 12px;
                padding-bottom: 12px;
                padding-left: 12px;
                spacing-horizontal: 10px;
                spacing-vertical: 30px;

                Row {
                    HorizontalLayout {
                        spacing: 10px;
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-reverb;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Reverb";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-reverb = v; root.reflect-reverb-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-size;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Size";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-size = v; root.reflect-size-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-spread;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Spread";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-spread = v; root.reflect-spread-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-damp;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Damp";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-damp = v; root.reflect-damp-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-decay;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Decay";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-decay = v; root.reflect-decay-changed(v); }
                        }
                        VerticalLayout {
                            width: 156px;
                            HorizontalLayout {
                                padding-bottom: 12px;
                                RDSButton {
                                    label: "Clear";
                                    button-width: 76px;
                                    button-height: 28px;
                                    clicked => root.reflect-clear();
                                }
                            }
                            HorizontalLayout {
                                RDSButton {
                                    label: "Freeze";
                                    active: root.reflect-freeze;
                                    button-width: 76px;
                                    button-height: 28px;
                                    clicked => root.toggle-reflect-freeze();
                                }
                            }
                        }
                    }
                }

                Row {
                    HorizontalLayout {
                        spacing: 10px;
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-delay;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Delay";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-delay = v; root.reflect-delay-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-time;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Time";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            readout-text: root.reflect-time-readout;
                            value-changed(v) => { root.reflect-time = v; root.reflect-time-changed(v); }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-feedback;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Feedback";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-feedback = v; root.reflect-feedback-changed(v); }
                        }
                        VerticalLayout {
                            HorizontalLayout {
                                padding-bottom: 12px;
                                RDSComboBox {
                                    width: 74px;
                                    model: ["Straight", "Dotted", "Triplet", "Free"];
                                    current-index: root.reflect-time-mode;
                                    selected(index) => {
                                        root.reflect-time-mode = index;
                                        root.reflect-time-mode-selected(index);
                                    }
                                }
                            }
                            HorizontalLayout {
                                RDSComboBox {
                                    width: 74px;
                                    model: root.reflect-time-division-model;
                                    current-index: root.reflect-time-division-index-ui;
                                    enabled: root.reflect-time-mode != 3;
                                    selected(index) => {
                                        let next = Math.max(0, Math.min(root.reflect-time-divisions.length - 1, index));
                                        let norm = next / Math.max(1, root.reflect-time-divisions.length - 1);
                                        root.reflect-time = norm;
                                        root.reflect-time-changed(norm);
                                    }
                                }
                            }
                        }
                        RDSKnob {
                            renderer: "lo-fi";
                            value: root.reflect-post-gain;
                            min-value: 0; max-value: 1;
                            size: 74px; indicator-position: 25px;
                            label: "Post Gain";
                            label-pos: "top-center";
                            label-font-size: 10px;
                            label-font-weight: 500;
                            sensitivity: 0.01; scroll-sensitivity: 0.01;
                            value-changed(v) => { root.reflect-post-gain = v; root.reflect-post-gain-changed(v); }
                        }
                    }
                }
            }
        }
    }
}
