import { Button } from "std-widgets.slint";

import { Theme } from "../theme/index.slint";
import {
    RDSHeaderLabel,
    RDSButton,
    RDSSlider,
    RDSVertVUMeter,
    RDSKnob,
    RDSWaveformViz,
    RDSComboBox,
    RDSCircleToggle
} from "../components/index.slint";
import { GranulatorDevice } from "../devices/granulator_device.slint";
import { SilkDevice } from "../devices/silk_device.slint";
import { G8Device } from "../devices/g8_device.slint";
import { Modul8Device } from "../devices/modul8_device.slint";
import { TextureDevice } from "../devices/texture_device.slint";
import { ReflectDevice } from "../devices/reflect_device.slint";

export component TapeEngine inherits Rectangle {
    in property <bool> is-recording: false;

    in-out property <float> track-level: 1.0;
    in property <float> track-meter-left: 0.0;
    in property <float> track-meter-right: 0.0;

    in property <[float]> waveform;
    in property <[string]> waveform_time_labels;
    in property <int> playhead-index: 0;
    in property <bool> video-enabled: false;
    in property <image> video-frame;
    in property <[float]> mosaic-grain-markers;

    in-out property <float> tape-speed: 1.0;
    in property <float> tape-tempo: 120.0;
    in-out property <float> tape-rotate: 0.0;
    in-out property <float> trigger-start: 0.0;
    in-out property <float> loop-start: 0.0;
    in-out property <float> loop-length: 1.0;
    in-out property <float> tape-glide: 0.0;
    in-out property <float> tape-sos: 0.0;
    in-out property <float> loop-xfade: 0.0;

    in property <[string]> tape-rate-modes;
    in-out property <int> tape-rate-mode: 0;
    in property <[string]> loop-modes;
    in-out property <int> loop-mode: 0;

    in-out property <bool> track-muted: false;
    in-out property <bool> loop-enabled: true;
    in-out property <bool> tape-reverse: false;
    in-out property <bool> tape-freeze: false;
    in-out property <bool> tape-keylock: false;
    in-out property <bool> tape-monitor: false;
    in-out property <bool> tape-overdub: false;
    in property <float> tape-video-duration: 0.0;

    private property <[string]> tape-rate-labels: [
        "1/64", "1/32", "1/16", "1/8", "1/4", "1/2", "1", "2", "4", "8", "16"
    ];
    private property <[float]> tape-rate-bars: [
        1.0 / 64.0,
        1.0 / 32.0,
        1.0 / 16.0,
        1.0 / 8.0,
        1.0 / 4.0,
        1.0 / 2.0,
        1.0,
        2.0,
        4.0,
        8.0,
        16.0
    ];
    private property <int> tape-rate-index:
        Math.round((Math.abs(root.tape-speed) / 4.0) * (root.tape-rate-labels.length - 1));
    private property <string> tape-rate-label:
        root.tape-rate-labels[
            Math.max(0, Math.min(root.tape-rate-labels.length - 1, root.tape-rate-index))
        ];
    private property <float> tape-rate-bars-selected:
        root.tape-rate-bars[
            Math.max(0, Math.min(root.tape-rate-bars.length - 1, root.tape-rate-index))
        ];
    private property <string> tape-speed-readout:
        root.tape-rate-mode == 1
            ? root.tape-rate-label
            : (root.tape-rate-mode == 2
                ? "Tempo 1.5x"
                : (root.tape-rate-mode == 3
                    ? "Tempo 0.67x"
                    : (Math.round(root.tape-speed * 100) / 100 + "x")));
    private property <string> tape-rotate-readout:
        root.tape-video-duration > 0
            ? ((Math.floor((root.tape-rotate * root.tape-video-duration) * 100) / 100) + "s")
            : "--";
    private property <string> tape-trigger-readout:
        root.tape-video-duration > 0
            ? ((Math.floor((root.trigger-start * root.tape-video-duration) * 100) / 100) + "s")
            : "--";
    private property <string> tape-loop-start-readout:
        root.tape-video-duration > 0
            ? ((Math.floor((root.loop-start * root.tape-video-duration) * 100) / 100) + "s")
            : "--";
    private property <float> tape-bars-total:
        root.tape-video-duration > 0
            ? (root.tape-video-duration / ((60.0 / Math.max(1.0, root.tape-tempo)) * 4.0))
            : 0.0;
    private property <float> tape-speed-factor:
        root.tape-rate-mode == 1
            ? 1.0
            : Math.max(0.0001, Math.abs(root.tape-speed));
    private property <float> tape-bars-effective:
        root.tape-rate-mode == 1
            ? root.tape-rate-bars-selected
            : (root.tape-bars-total / root.tape-speed-factor);
    private property <float> tape-loop-bars:
        root.tape-bars-effective * root.loop-length;
    private property <int> tape-loop-bars-whole:
        Math.floor(root.tape-loop-bars);
    private property <int> tape-loop-beats:
        Math.round((root.tape-loop-bars - root.tape-loop-bars-whole) * 4.0);
    private property <string> tape-loop-bars-readout:
        root.tape-bars-total > 0
            ? (root.tape-loop-bars-whole <= 0
                ? (Math.max(0, Math.min(4, root.tape-loop-beats)) + " beats")
                : (Math.max(0, Math.min(4, root.tape-loop-beats)) == 0
                    ? (root.tape-loop-bars-whole + " bars")
                    : (root.tape-loop-bars-whole + " bars " + Math.max(0, Math.min(4, root.tape-loop-beats)) + " beats")))
            : (Math.round(root.loop-length * 100) + "%");
    private property <string> tape-loop-length-readout:
        root.tape-rate-mode == 1
            ? root.tape-loop-bars-readout
            : (root.tape-video-duration > 0
                ? ((Math.floor((root.loop-length * root.tape-video-duration) * 100) / 100) + "s")
                : "--");
    private property <string> tape-glide-readout:
        Math.round(root.tape-glide * 100) + "%";
    private property <string> tape-sos-readout:
        Math.round(root.tape-sos * 100) + "%";
    private property <string> tape-xfade-readout:
        Math.round((root.loop-xfade / 0.5) * 100) + "%";

    in-out property <bool> mosaic-enabled: true;
    in-out property <bool> mosaic-loop-lock: false;
    in-out property <float> mosaic-pitch: 0.0;
    in-out property <float> mosaic-rate: 0.5;
    in-out property <float> mosaic-size: 0.5;
    in-out property <float> mosaic-contour: 0.5;
    in-out property <float> mosaic-warp: 0.0;
    in-out property <float> mosaic-spray: 0.0;
    in-out property <float> mosaic-pattern: 0.0;
    in-out property <float> mosaic-wet: 0.0;
    in-out property <float> mosaic-post-gain: 0.5;
    in-out property <float> mosaic-detune: 0.0;
    in-out property <float> mosaic-spatial: 0.0;
    in-out property <float> mosaic-rand-rate: 0.0;
    in-out property <float> mosaic-rand-size: 0.0;
    in-out property <float> mosaic-sos: 0.0;

    in-out property <bool> ring-enabled: false;
    in-out property <float> ring-cutoff: 0.5;
    in-out property <float> ring-resonance: 0.0;
    in-out property <float> ring-decay: 0.0;
    in-out property <float> ring-pitch: 0.5;
    in property <[string]> ring-decay-modes;
    in-out property <int> ring-decay-mode: 0;
    in-out property <float> ring-slope: 0.5;
    in-out property <float> ring-tone: 0.5;
    in-out property <float> ring-tilt: 0.5;
    in-out property <float> ring-wet: 0.0;
    in-out property <float> ring-detune: 0.0;
    in-out property <float> ring-waves: 0.0;
    in-out property <float> ring-waves-rate: 0.5;
    in-out property <float> ring-noise: 0.0;
    in-out property <float> ring-noise-rate: 0.5;
    in-out property <bool> ring-pre-post: true;
    in-out property <bool> texture-enabled: false;
    in-out property <bool> texture-gate: false;
    in-out property <float> texture-drive: 0.0;
    in-out property <float> texture-compress: 0.0;
    in-out property <float> texture-crush: 0.0;
    in-out property <float> texture-tilt: 0.0;
    in-out property <float> texture-noise: 0.0;
    in-out property <float> texture-noise-decay: 0.0;
    in-out property <float> texture-noise-color: 0.0;
    in-out property <float> texture-wet: 1.0;
    in-out property <float> texture-post-gain: 0.5;
    in-out property <bool> reflect-enabled: false;
    in-out property <bool> reflect-freeze: false;
    in-out property <float> reflect-delay: 0.0;
    in-out property <float> reflect-time: 0.5;
    in-out property <int> reflect-time-mode: 0;
    in-out property <float> reflect-reverb: 0.0;
    in-out property <float> reflect-size: 0.5;
    in-out property <float> reflect-feedback: 0.0;
    in-out property <float> reflect-spread: 0.0;
    in-out property <float> reflect-damp: 0.5;
    in-out property <float> reflect-decay: 0.5;
    in-out property <float> reflect-post-gain: 0.5;

    in-out property <bool> g8-enabled: true;
    in-out property <int> g8-rate-index: 0;
    in-out property <[float]> g8-steps: [
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0
    ];

    callback load-sample();
    callback save-sample();
    callback toggle-record();
    callback audition-start();
    callback audition-end();

    callback track-level-changed(value: float);
    callback tape-speed-changed(value: float);
    callback tape-rotate-changed(value: float);
    callback trigger-start-changed(value: float);
    callback loop-start-changed(value: float);
    callback loop-length-changed(value: float);
    callback tape-glide-changed(value: float);
    callback tape-sos-changed(value: float);
    callback loop-xfade-changed(value: float);
    callback tape-rate-mode-selected(index: int);
    callback loop-mode-selected(index: int);
    in property <[string]> modul8-target-options;
    in-out property <bool> modul8-enabled: false;
    in-out property <[int]> modul8-wave: [0, 0, 0, 0, 0, 0, 0, 0];
    in-out property <[float]> modul8-rate: [1, 1, 1, 1, 1, 1, 1, 1];
    in-out property <[bool]> modul8-sync: [true, true, true, true, true, true, true, true];
    in-out property <[int]> modul8-division: [0, 0, 0, 0, 0, 0, 0, 0];
    in-out property <[float]> modul8-amount: [0, 0, 0, 0, 0, 0, 0, 0];
    in-out property <[float]> modul8-bias: [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5];
    in-out property <[int]> modul8-target: [0, 0, 0, 0, 0, 0, 0, 0];


    callback toggle-track-mute();
    callback toggle-loop-enabled();
    callback toggle-tape-reverse();
    callback toggle-tape-freeze();
    callback toggle-tape-keylock();
    callback toggle-tape-monitor();
    callback toggle-tape-overdub();

    callback toggle-mosaic-enabled();
    callback toggle-mosaic-loop-lock();
    callback mosaic-pitch-changed(value: float);
    callback mosaic-rate-changed(value: float);
    callback mosaic-size-changed(value: float);
    callback mosaic-contour-changed(value: float);
    callback mosaic-warp-changed(value: float);
    callback mosaic-spray-changed(value: float);
    callback mosaic-pattern-changed(value: float);
    callback mosaic-wet-changed(value: float);
    callback mosaic-post-gain-changed(value: float);
    callback mosaic-detune-changed(value: float);
    callback mosaic-spatial-changed(value: float);
    callback mosaic-rand-rate-changed(value: float);
    callback mosaic-rand-size-changed(value: float);
    callback mosaic-sos-changed(value: float);

    callback toggle-ring-enabled();
    callback ring-cutoff-changed(value: float);
    callback ring-resonance-changed(value: float);
    callback ring-decay-changed(value: float);
    callback ring-pitch-changed(value: float);
    callback ring-decay-mode-selected(index: int);
    callback ring-slope-changed(value: float);
    callback ring-tone-changed(value: float);
    callback ring-tilt-changed(value: float);
    callback ring-wet-changed(value: float);
    callback ring-detune-changed(value: float);
    callback ring-waves-changed(value: float);
    callback ring-waves-rate-changed(value: float);
    callback ring-noise-changed(value: float);
    callback ring-noise-rate-changed(value: float);
    callback toggle-ring-pre-post();
    callback toggle-texture-enabled();
    callback toggle-texture-gate();
    callback texture-drive-changed(value: float);
    callback texture-compress-changed(value: float);
    callback texture-crush-changed(value: float);
    callback texture-tilt-changed(value: float);
    callback texture-noise-changed(value: float);
    callback texture-noise-decay-changed(value: float);
    callback texture-noise-color-changed(value: float);
    callback texture-wet-changed(value: float);
    callback texture-post-gain-changed(value: float);
    callback toggle-reflect-enabled();
    callback toggle-reflect-freeze();
    callback reflect-clear();
    callback reflect-delay-changed(value: float);
    callback reflect-time-changed(value: float);
    callback reflect-time-mode-selected(index: int);
    callback reflect-reverb-changed(value: float);
    callback reflect-size-changed(value: float);
    callback reflect-feedback-changed(value: float);
    callback reflect-spread-changed(value: float);
    callback reflect-damp-changed(value: float);
    callback reflect-decay-changed(value: float);
    callback reflect-post-gain-changed(value: float);
    callback toggle-g8-enabled();
    callback g8-rate-selected(index: int);
    callback g8-step-changed(index: int, value: float);
    callback toggle-modul8-enabled();
    callback modul8-wave-changed(index: int, value: int);
    callback modul8-rate-changed(index: int, value: float);
    callback modul8-sync-changed(index: int, value: bool);
    callback modul8-division-changed(index: int, value: int);
    callback modul8-amount-changed(index: int, value: float);
    callback modul8-bias-changed(index: int, value: float);
    callback modul8-target-changed(index: int, value: int);

    width: 1242px;
    background: transparent;

    // Engine Container
    VerticalLayout {
        spacing: 8px;
        padding: 12px;

        // Engine Title
        RDSHeaderLabel {
            text: "Tape-Deck";
            horizontal-alignment: left;
            padding-horizontal: 12px;
            padding-vertical: 6px;
            right-padding: 12px;
            HorizontalLayout {
                spacing: 6px;
                alignment: center;
                RDSCircleToggle {
                    y: 2px;
                    active: !root.track-muted;
                    label: "Mute";
                    label-active: "Live";
                    label-pos: "left";
                    label-color: Theme.active.text_secondary;
                    label-active-color: Theme.active.text_primary;
                    label-font-size: 11px;
                    label-font-weight: 500;
                    clicked => root.toggle-track-mute();
                }
            }
        }

        // Engine Controls
        Rectangle {
            background: Theme.active.ui_device_panel_bg;
            border-width: 2px;
            border-radius: 6px;
            border-color: Theme.active.border-strong;
            VerticalLayout {
                HorizontalLayout {
                    spacing: 8px;
                    padding: 12px;
                    RDSButton {
                        label: "Load Sample";
                        layout-stretch: 1;
                        border-width: 2px;
                        clicked => root.load-sample();
                    }
                    RDSButton {
                        label: "Save Sample";
                        layout-stretch: 1;
                        border-width: 2px;
                        clicked => root.save-sample();
                    }
                    RDSButton {
                        label: root.is-recording ? "Stop Record" : "Record";
                        layout-stretch: 1;
                        border-width: 2px;
                        clicked => root.toggle-record();
                    }
                    RDSButton {
                        label: "Audition";
                        layout-stretch: 1;
                        border-width: 2px;
                        pressed => root.audition-start();
                        released => root.audition-end();
                    }
                }

                HorizontalLayout {
                    padding-right: 12px;
                    padding-bottom: 12px;
                    padding-left: 12px;
                    RDSSlider {
                        value: root.track-level;
                        min-value: 0;
                        max-value: 1;
                        orientation: "vertical";
                        size: "small";
                        height-override: 200px;
                        width: 40px;
                        value-changed(v) => {
                            root.track-level = v;
                            root.track-level-changed(v);
                        }
                    }

                    VerticalLayout {
                        width: 72px;
                        height: 200px;
                        padding-left: 8px;
                        HorizontalLayout {
                            spacing: 4px;
                            RDSVertVUMeter { level: root.track-meter-left; fill-color: #34d399; width: 24px; height: 200px; }
                            RDSVertVUMeter { level: root.track-meter-right; fill-color: #60a5fa; width: 24px; height: 200px; }
                        }
                    }

                    Rectangle {
                        border-width: 2px;
                        width: parent.width - 420px;
                        height: 200px;
                        border-radius: 6px;
                        border-color: Theme.active.border-strong;
                        clip: true;
                        RDSWaveformViz {
                            width: parent.width;
                            height: parent.height;
                            visible: !root.video-enabled;
                            waveform: root.waveform;
                            waveform_time_labels: root.waveform_time_labels;
                            playhead-index: root.playhead-index;
                            loop-start: root.loop-start;
                            loop-length: root.loop-length;
                            loop-enabled: root.loop-enabled;
                            trigger-start: root.trigger-start;
                            grain-markers: root.mosaic-grain-markers;
                        }
                        Image {
                            width: parent.width;
                            height: parent.height;
                            visible: root.video-enabled;
                            source: root.video-frame;
                            image-fit: contain;
                        }
                    }

                    VerticalLayout {
                        padding-left: 12px;
                        Rectangle {
                            background: #121216;
                            border-radius: 6px;
                            border-color: #2a2a35;
                            border-width: 2px;

                            GridLayout {
                                padding: 12px;
                                spacing-horizontal: 24px;
                                spacing-vertical: 10px;
                                Row {
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "T.Start"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.trigger-start;
                                            min-value: 0;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            scroll-sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            infinite-rotary: root.video-enabled;
                                            readout-text: root.tape-trigger-readout;
                                            value-changed(v) => {
                                                root.trigger-start = v;
                                                root.trigger-start-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "L.Start"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.loop-start;
                                            min-value: 0;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            scroll-sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            infinite-rotary: root.video-enabled;
                                            readout-text: root.tape-loop-start-readout;
                                            value-changed(v) => {
                                                root.loop-start = v;
                                                root.loop-start-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "Length"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.loop-length;
                                            min-value: 0.01;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            scroll-sensitivity: root.video-enabled ? 0.001 : 0.01;
                                            infinite-rotary: root.video-enabled;
                                            readout-text: root.tape-loop-length-readout;
                                            value-changed(v) => {
                                                root.loop-length = v;
                                                root.loop-length-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "Rotate"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.tape-rotate;
                                            min-value: 0;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: 0.01;
                                            scroll-sensitivity: 0.01;
                                            readout-text: root.tape-rotate-readout;
                                            value-changed(v) => {
                                                root.tape-rotate = v;
                                                root.tape-rotate-changed(v);
                                            }
                                        }
                                    }
                                }
                                Row {
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "Speed"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.tape-speed;
                                            min-value: -4;
                                            max-value: 4;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: 0.05;
                                            scroll-sensitivity: 0.05;
                                            readout-text: root.tape-speed-readout;
                                            value-changed(v) => {
                                                root.tape-speed = v;
                                                root.tape-speed-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "Glide"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.tape-glide;
                                            min-value: 0;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: 0.01;
                                            scroll-sensitivity: 0.01;
                                            readout-text: root.tape-glide-readout;
                                            value-changed(v) => {
                                                root.tape-glide = v;
                                                root.tape-glide-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "SOS"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.tape-sos;
                                            min-value: 0;
                                            max-value: 1;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: 0.01;
                                            scroll-sensitivity: 0.01;
                                            readout-text: root.tape-sos-readout;
                                            value-changed(v) => {
                                                root.tape-sos = v;
                                                root.tape-sos-changed(v);
                                            }
                                        }
                                    }
                                    VerticalLayout {
                                        spacing: 4px;
                                        Text { text: "XFade"; color: Theme.active.text_secondary; font-size: 10px; horizontal-alignment: center; }
                                        RDSKnob {
                                            renderer: "lo-fi";
                                            value: root.loop-xfade;
                                            min-value: 0;
                                            max-value: 0.5;
                                            size: 44px;
                                            indicator-position: 14px;
                                            sensitivity: 0.005;
                                            scroll-sensitivity: 0.005;
                                            readout-text: root.tape-xfade-readout;
                                            value-changed(v) => {
                                                root.loop-xfade = v;
                                                root.loop-xfade-changed(v);
                                            }
                                        }
                                    }
                                }
                                Row {
                                    HorizontalLayout {
                                        colspan: 4;
                                        spacing: 12px;
                                        alignment: space-between;
                                        VerticalLayout {
                                            spacing: 2px;
                                            width: 126px;
                                            Text { text: "Rate Mode"; color: Theme.active.text_secondary; font-size: 10px; }
                                            RDSComboBox {
                                                width: 110px;
                                                height: 24px;
                                                model: root.tape-rate-modes;
                                                current-index: root.tape-rate-mode;
                                                selected => {
                                                    root.tape-rate-mode = self.current-index;
                                                    root.tape-rate-mode-selected(self.current-index);
                                                }
                                            }
                                        }
                                        VerticalLayout {
                                            spacing: 2px;
                                            width: 120px;
                                            Text { text: "Loop Mode"; color: Theme.active.text_secondary; font-size: 10px; }
                                            RDSComboBox {
                                                width: 110px;
                                                height: 24px;
                                                model: root.loop-modes;
                                                current-index: root.loop-mode;
                                                selected => {
                                                    root.loop-mode = self.current-index;
                                                    root.loop-mode-selected(self.current-index);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 16px;
                    width: parent.width;

                    VerticalLayout {
                        spacing: 12px;
                        HorizontalLayout {
                            spacing: 8px;
                            padding-right: 12px;
                            padding-bottom: 12px;
                            padding-left: 12px;
                            RDSButton { label: root.loop-enabled ? "Loop On" : "Loop Off"; clicked => root.toggle-loop-enabled(); }
                            RDSButton { label: root.tape-reverse ? "Reverse On" : "Reverse Off"; clicked => root.toggle-tape-reverse(); }
                            RDSButton { label: root.tape-freeze ? "Freeze On" : "Freeze Off"; clicked => root.toggle-tape-freeze(); }
                            RDSButton { label: root.tape-keylock ? "Keylock On" : "Keylock Off"; clicked => root.toggle-tape-keylock(); }
                            RDSButton { label: root.tape-monitor ? "Monitor On" : "Monitor Off"; clicked => root.toggle-tape-monitor(); }
                            RDSButton { label: root.tape-overdub ? "Overdub On" : "Overdub Off"; clicked => root.toggle-tape-overdub(); }
                        }
                    }
                }
            }
        }

        // Downstream Devices
        VerticalLayout {
            width: parent.width;

            HorizontalLayout {
                spacing: 8px;

                // Granulator Device
                Rectangle {
                    width: parent.width / 2 - 16px;
                    height: 266px;

                    GranulatorDevice {
                        mosaic-enabled <=> root.mosaic-enabled;
                        mosaic-loop-lock <=> root.mosaic-loop-lock;
                        mosaic-pitch <=> root.mosaic-pitch;
                        mosaic-rate <=> root.mosaic-rate;
                        mosaic-size <=> root.mosaic-size;
                        mosaic-contour <=> root.mosaic-contour;
                        mosaic-warp <=> root.mosaic-warp;
                        mosaic-spray <=> root.mosaic-spray;
                        mosaic-pattern <=> root.mosaic-pattern;
                        mosaic-wet <=> root.mosaic-wet;
                        mosaic-post-gain <=> root.mosaic-post-gain;
                        mosaic-detune <=> root.mosaic-detune;
                        mosaic-spatial <=> root.mosaic-spatial;
                        mosaic-rand-rate <=> root.mosaic-rand-rate;
                        mosaic-rand-size <=> root.mosaic-rand-size;
                        mosaic-sos <=> root.mosaic-sos;
                        toggle-mosaic-enabled => root.toggle-mosaic-enabled();
                        mosaic-pitch-changed(value) => { root.mosaic-pitch-changed(value); }
                        mosaic-rate-changed(value) => { root.mosaic-rate-changed(value); }
                        mosaic-size-changed(value) => { root.mosaic-size-changed(value); }
                        mosaic-contour-changed(value) => { root.mosaic-contour-changed(value); }
                        mosaic-warp-changed(value) => { root.mosaic-warp-changed(value); }
                        mosaic-spray-changed(value) => { root.mosaic-spray-changed(value); }
                        mosaic-pattern-changed(value) => { root.mosaic-pattern-changed(value); }
                        mosaic-wet-changed(value) => { root.mosaic-wet-changed(value); }
                        mosaic-post-gain-changed(value) => { root.mosaic-post-gain-changed(value); }
                        mosaic-detune-changed(value) => { root.mosaic-detune-changed(value); }
                        mosaic-spatial-changed(value) => { root.mosaic-spatial-changed(value); }
                        mosaic-rand-rate-changed(value) => { root.mosaic-rand-rate-changed(value); }
                        mosaic-rand-size-changed(value) => { root.mosaic-rand-size-changed(value); }
                        mosaic-sos-changed(value) => { root.mosaic-sos-changed(value); }
                        toggle-mosaic-loop-lock => root.toggle-mosaic-loop-lock();
                    }
                }

                // Silk Device
                Rectangle {
                    width: parent.width / 2 - 16px;
                    height: 266px;

                    SilkDevice {
                        ring-enabled <=> root.ring-enabled;
                        ring-cutoff <=> root.ring-cutoff;
                        ring-resonance <=> root.ring-resonance;
                        ring-decay <=> root.ring-decay;
                        ring-pitch <=> root.ring-pitch;
                        ring-decay-modes: root.ring-decay-modes;
                        ring-decay-mode <=> root.ring-decay-mode;
                        ring-slope <=> root.ring-slope;
                        ring-tone <=> root.ring-tone;
                        ring-tilt <=> root.ring-tilt;
                        ring-wet <=> root.ring-wet;
                        ring-detune <=> root.ring-detune;
                        ring-waves <=> root.ring-waves;
                        ring-waves-rate <=> root.ring-waves-rate;
                        ring-noise <=> root.ring-noise;
                        ring-noise-rate <=> root.ring-noise-rate;
                        ring-pre-post <=> root.ring-pre-post;
                        toggle-ring-enabled => root.toggle-ring-enabled();
                        toggle-ring-pre-post => root.toggle-ring-pre-post();
                        ring-cutoff-changed(value) => { root.ring-cutoff-changed(value); }
                        ring-resonance-changed(value) => { root.ring-resonance-changed(value); }
                        ring-decay-changed(value) => { root.ring-decay-changed(value); }
                        ring-pitch-changed(value) => { root.ring-pitch-changed(value); }
                        ring-decay-mode-selected(index) => { root.ring-decay-mode-selected(index); }
                        ring-slope-changed(value) => { root.ring-slope-changed(value); }
                        ring-tone-changed(value) => { root.ring-tone-changed(value); }
                        ring-tilt-changed(value) => { root.ring-tilt-changed(value); }
                        ring-wet-changed(value) => { root.ring-wet-changed(value); }
                        ring-detune-changed(value) => { root.ring-detune-changed(value); }
                        ring-waves-changed(value) => { root.ring-waves-changed(value); }
                        ring-waves-rate-changed(value) => { root.ring-waves-rate-changed(value); }
                        ring-noise-changed(value) => { root.ring-noise-changed(value); }
                        ring-noise-rate-changed(value) => { root.ring-noise-rate-changed(value); }
                    }
                }
            }

            HorizontalLayout {
                spacing: 8px;

                // Texture Device
                Rectangle {
                    width: parent.width / 2 - 16px;
                    height: 266px;

                    TextureDevice {
                        texture-enabled <=> root.texture-enabled;
                        texture-gate <=> root.texture-gate;
                        texture-drive <=> root.texture-drive;
                        texture-compress <=> root.texture-compress;
                        texture-crush <=> root.texture-crush;
                        texture-tilt <=> root.texture-tilt;
                        texture-noise <=> root.texture-noise;
                        texture-noise-decay <=> root.texture-noise-decay;
                        texture-noise-color <=> root.texture-noise-color;
                        texture-wet <=> root.texture-wet;
                        texture-post-gain <=> root.texture-post-gain;
                        toggle-texture-enabled => root.toggle-texture-enabled();
                        toggle-texture-gate => root.toggle-texture-gate();
                        texture-drive-changed(value) => { root.texture-drive-changed(value); }
                        texture-compress-changed(value) => { root.texture-compress-changed(value); }
                        texture-crush-changed(value) => { root.texture-crush-changed(value); }
                        texture-tilt-changed(value) => { root.texture-tilt-changed(value); }
                        texture-noise-changed(value) => { root.texture-noise-changed(value); }
                        texture-noise-decay-changed(value) => { root.texture-noise-decay-changed(value); }
                        texture-noise-color-changed(value) => { root.texture-noise-color-changed(value); }
                        texture-wet-changed(value) => { root.texture-wet-changed(value); }
                        texture-post-gain-changed(value) => { root.texture-post-gain-changed(value); }
                    }
                }

                // Reflect Device
                Rectangle {
                    width: parent.width / 2 - 16px;
                    height: 266px;

                    ReflectDevice {
                        reflect-enabled <=> root.reflect-enabled;
                        reflect-freeze <=> root.reflect-freeze;
                        reflect-delay <=> root.reflect-delay;
                        reflect-time <=> root.reflect-time;
                        reflect-time-mode <=> root.reflect-time-mode;
                        reflect-reverb <=> root.reflect-reverb;
                        reflect-size <=> root.reflect-size;
                        reflect-feedback <=> root.reflect-feedback;
                        reflect-spread <=> root.reflect-spread;
                        reflect-damp <=> root.reflect-damp;
                        reflect-decay <=> root.reflect-decay;
                        reflect-post-gain <=> root.reflect-post-gain;
                        toggle-reflect-enabled => root.toggle-reflect-enabled();
                        toggle-reflect-freeze => root.toggle-reflect-freeze();
                        reflect-clear => root.reflect-clear();
                        reflect-delay-changed(value) => { root.reflect-delay-changed(value); }
                        reflect-time-changed(value) => { root.reflect-time-changed(value); }
                        reflect-time-mode-selected(index) => { root.reflect-time-mode-selected(index); }
                        reflect-reverb-changed(value) => { root.reflect-reverb-changed(value); }
                        reflect-size-changed(value) => { root.reflect-size-changed(value); }
                        reflect-feedback-changed(value) => { root.reflect-feedback-changed(value); }
                        reflect-spread-changed(value) => { root.reflect-spread-changed(value); }
                        reflect-damp-changed(value) => { root.reflect-damp-changed(value); }
                        reflect-decay-changed(value) => { root.reflect-decay-changed(value); }
                        reflect-post-gain-changed(value) => { root.reflect-post-gain-changed(value); }
                    }
                }
            }

            HorizontalLayout {
                spacing: 8px;

                // Modul8 Device
                Rectangle {
                    width: 1216px;
                    height: 354px;

                    Modul8Device {
                        width: parent.width;
                        modul8-enabled <=> root.modul8-enabled;
                        modul8-target-options: root.modul8-target-options;
                        modul8-wave <=> root.modul8-wave;
                        modul8-rate <=> root.modul8-rate;
                        modul8-sync <=> root.modul8-sync;
                        modul8-division <=> root.modul8-division;
                        modul8-amount <=> root.modul8-amount;
                        modul8-bias <=> root.modul8-bias;
                        modul8-target <=> root.modul8-target;
                        toggle-modul8-enabled => root.toggle-modul8-enabled();
                        modul8-wave-changed(index, value) => { root.modul8-wave-changed(index, value); }
                        modul8-rate-changed(index, value) => { root.modul8-rate-changed(index, value); }
                        modul8-sync-changed(index, value) => { root.modul8-sync-changed(index, value); }
                        modul8-division-changed(index, value) => { root.modul8-division-changed(index, value); }
                        modul8-amount-changed(index, value) => { root.modul8-amount-changed(index, value); }
                        modul8-bias-changed(index, value) => { root.modul8-bias-changed(index, value); }
                        modul8-target-changed(index, value) => { root.modul8-target-changed(index, value); }
                    }
                }
            }

            HorizontalLayout {
                spacing: 8px;

                // G8 Device
                Rectangle {
                    width: 1216px;
                    height: 186px;

                    G8Device {
                        gate-enabled <=> root.g8-enabled;
                        gate-rate-index <=> root.g8-rate-index;
                        gate-steps <=> root.g8-steps;
                        toggle-gate-enabled => root.toggle-g8-enabled();
                        gate-rate-selected(index) => { root.g8-rate-selected(index); }
                        gate-step-changed(index, value) => { root.g8-step-changed(index, value); }
                    }
                }
            }
        }
    }
}

// Preview helper for the Slint VS Code extension.
export component TapeEnginePreview inherits Window {
    width: 1242px;
    height: 760px;
    TapeEngine { width: 1242px; height: 760px; }
}
