import { Button, ComboBox, ScrollView } from "std-widgets.slint";

component Knob {
    in property <string> label;
    in-out property <float> value: 0.5;
    
    // Angle as an actual angle type
    property <angle> cur-angle: (root.value * 270.0 - 135.0) * 1deg;
    
    width: 60px;
    height: 85px;
    
    VerticalLayout {
        spacing: 8px;
        alignment: center;
        
        // Knob Container
        Rectangle {
            width: 50px;
            height: 50px;
            background: #1a1a1a;
            border-radius: 25px;
            border-width: 2px;
            border-color: #000;
            
            TouchArea {
                property <length> last-y;
                
                pointer-event(event) => {
                    if (event.kind == PointerEventKind.down) {
                        self.last-y = self.mouse-y;
                    }
                }
                moved => {
                    if (self.pressed) {
                        let delta = (self.last-y - self.mouse-y) / 100px;
                        root.value = Math.clamp(root.value + delta, 0.0, 1.0);
                        self.last-y = self.mouse-y;
                    }
                }
            }
            
            // Outer Bezel
            Rectangle {
                width: 46px;
                height: 46px;
                border-radius: 23px;
                background: @linear-gradient(135deg, #444 0%, #111 100%);
            }

            // Main Knob Body
            Rectangle {
                width: 38px;
                height: 38px;
                border-radius: 19px;
                background: @linear-gradient(135deg, #333 0%, #222 50%, #111 100%);
                
                // Indicator (Procedural Line)
                Path {
                    width: 100%;
                    height: 100%;
                    stroke: #ff6d00;
                    stroke-width: 3px;
                    viewbox-width: 100;
                    viewbox-height: 100;
                    
                    MoveTo { 
                        x: 50.0 + 10.0 * Math.sin(root.cur-angle); 
                        y: 50.0 - 10.0 * Math.cos(root.cur-angle); 
                    }
                    LineTo { 
                        x: 50.0 + 18.0 * Math.sin(root.cur-angle); 
                        y: 50.0 - 18.0 * Math.cos(root.cur-angle); 
                    }
                }

                // Surface Texture / Highlight
                Rectangle {
                    width: 34px;
                    height: 34px;
                    border-radius: 17px;
                    background: @linear-gradient(135deg, #ffffff11 0%, #00000033 100%);
                }
            }
        }
        
        Text {
            text: root.label;
            color: #ccc;
            font-size: 11px;
            horizontal-alignment: center;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
    }
}

component VerticalVU {
    in property <float> value: 0.0;
    in property <string> label;
    
    width: 25px;
    height: 160px;
    
    VerticalLayout {
        spacing: 4px;
        Text {
            text: root.label;
            color: #888;
            font-size: 9px;
            horizontal-alignment: center;
        }
        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            background: #0a0a0a;
            border-radius: 2px;
            border-width: 1px;
            border-color: #333;
            
            // LED segments simulation
            for i in 15 : Rectangle {
                y: parent.height - (i + 1) * (parent.height / 15);
                height: (parent.height / 15) - 2px;
                width: parent.width - 4px;
                x: 2px;
                background: (root.value * 15 > i) ? 
                    (i > 12 ? #ff1744 : (i > 10 ? #ffeb3b : #00ff88)) : 
                    #1a1a1a;
                border-radius: 1px;
            }
        }
    }
}

component HardwareButton {
    in property <string> text;
    in property <color> bg: #4a148c;
    in-out property <bool> active: false;
    callback clicked();
    
    width: 100px;
    height: 34px;
    
    Rectangle {
        background: root.active ? root.bg.brighter(10%) : (ta.pressed ? root.bg.darker(20%) : root.bg);
        border-radius: 4px;
        border-width: 1px;
        border-color: #000;
        
        ta := TouchArea {
            clicked => { root.clicked(); }
        }
        
        // Shadow/Bezel
        Rectangle {
            width: 100%; height: 100%;
            border-radius: 4px;
            border-width: 2px;
            border-color: @linear-gradient(0deg, #00000066 0%, #ffffff33 100%);
        }

        Text {
            text: root.text;
            color: white;
            font-size: 11px;
            font-weight: 800;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
        
        // Lit indicator (small LED on the button)
        Rectangle {
            x: 5px;
            y: 5px;
            width: 4px;
            height: 4px;
            border-radius: 2px;
            background: root.active ? #00ff88 : #333;
            drop-shadow-blur: root.active ? 4px : 0px;
            drop-shadow-color: #00ff88;
        }
    }
}

component TransportButton {
    in property <color> btn-color;
    in property <bool> active;
    
    width: 40px;
    height: 35px;
    
    Rectangle {
        background: root.active ? root.btn-color : root.btn-color.darker(50%);
        border-radius: 4px;
        border-width: 2px;
        border-color: #1a1a1a;
        
        Rectangle {
            width: 12px; height: 12px;
            background: white;
            border-radius: 1px;
        }
    }
}

export component FigmaTestUI inherits Window {
    width: 1280px;
    height: 900px;
    background: #1e1e1e;

    callback action_triggered(string);

    in property <float> mock_meter_l: 0.0;
    in property <float> mock_meter_r: 0.0;
    in property <[float]> mock_waveform;

    VerticalLayout {
        padding: 20px;
        spacing: 15px;

        // TOP BAR
        HorizontalLayout {
            height: 120px;
            spacing: 20px;
            alignment: start;

            // Brand Logo Section
            VerticalLayout {
                width: 300px;
                alignment: start;
                Rectangle {
                    Text {
                        text: "GRAINRUST";
                        font-size: 48px;
                        color: #555;
                        font-weight: 900;
                        letter-spacing: -2px;
                    }
                    Text {
                        text: "Toolbox";
                        font-size: 18px;
                        color: white;
                        x: 180px;
                        y: 30px;
                    }
                }
                Rectangle {
                    height: 4px;
                    background: #ff6d00;
                    width: 280px;
                }
            }

            // Global Knobs
            Knob { label: "VOLUME"; value: 0.7; }
            
            // Tempo Display
            Rectangle {
                width: 100px;
                height: 60px;
                background: #111;
                border-radius: 4px;
                border-width: 2px;
                border-color: #333;
                y: 10px;
                
                Text {
                    text: "120";
                    color: #00ff88;
                    font-size: 28px;
                    font-family: "monospace";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Transport
            HorizontalLayout {
                spacing: 10px;
                y: 20px;
                TransportButton { btn-color: #00e676; active: true; }
                TransportButton { btn-color: #2979ff; active: false; }
                TransportButton { btn-color: #ff1744; active: false; }
            }
            
            // Main Display Area (Right)
            Rectangle {
                horizontal-stretch: 1;
                background: #000;
                border-radius: 8px;
                border-width: 3px;
                border-color: #333;
                
                Text {
                    text: "GR-01 VIRTUAL ANALOG GRANULAR SYNTHESIZER";
                    color: #444;
                    font-size: 14px;
                    font-weight: 900;
                    x: 20px;
                    y: 10px;
                }
                
                // Status Lights
                HorizontalLayout {
                    x: parent.width - 120px;
                    y: 15px;
                    spacing: 15px;
                    VerticalLayout {
                        spacing: 2px;
                        Rectangle { width: 8px; height: 8px; border-radius: 4px; background: #ff1744; }
                        Text { text: "CLIP"; color: #444; font-size: 8px; horizontal-alignment: center; }
                    }
                    VerticalLayout {
                        spacing: 2px;
                        Rectangle { width: 8px; height: 8px; border-radius: 4px; background: #00ff88; }
                        Text { text: "SYNC"; color: #444; font-size: 8px; horizontal-alignment: center; }
                    }
                    VerticalLayout {
                        spacing: 2px;
                        Rectangle { width: 8px; height: 8px; border-radius: 4px; background: #2979ff; }
                        Text { text: "MIDI"; color: #444; font-size: 8px; horizontal-alignment: center; }
                    }
                }
            }
        }

        // ACTION BUTTONS ROW
        HorizontalLayout {
            spacing: 15px;
            height: 40px;
            HardwareButton { text: "LOAD PROJECT"; bg: #4a148c; clicked => { root.action_triggered(self.text); } }
            HardwareButton { text: "SAVE PROJECT"; bg: #4a148c; clicked => { root.action_triggered(self.text); } }
            HardwareButton { text: "SETTINGS"; bg: #4a148c; clicked => { root.action_triggered(self.text); } }
            HardwareButton { text: "DUPLICATE"; bg: #4a148c; clicked => { root.action_triggered(self.text); } }
            
            Rectangle { width: 20px; } // Spacer
            
            Rectangle {
                width: 200px;
                background: #eee;
                border-radius: 4px;
                Text { text: "PICK AN ENGINE"; color: black; font-weight: 700; horizontal-alignment: center; vertical-alignment: center; }
            }
            HardwareButton { text: "LOAD ENGINE"; bg: #333; clicked => { root.action_triggered(self.text); } }
        }

        // MAIN CONTENT (TAPE DECK STYLE)
        Rectangle {
            vertical-stretch: 1;
            background: #2a2a2a;
            border-radius: 12px;
            border-width: 4px;
            border-color: #ff6d00;
            clip: true;

            VerticalLayout {
                padding: 10px;
                spacing: 10px;

                // Tape Deck Header
                HorizontalLayout {
                    height: 30px;
                    spacing: 10px;
                    Rectangle {
                        width: 20px; height: 20px;
                        background: white; border-radius: 10px;
                    }
                    Text {
                        text: "Tape Deck";
                        color: #ff6d00;
                        font-weight: 800;
                        font-size: 16px;
                    }
                    HorizontalLayout {
                        alignment: end;
                        horizontal-stretch: 1;
                        Rectangle {
                            width: 60px; height: 16px;
                            background: #111; border-radius: 8px;
                            Rectangle { x: 40px; width: 12px; height: 12px; y: 2px; background: #00ff88; border-radius: 6px; }
                        }
                    }
                }

                // Waveform & Meters Section
                HorizontalLayout {
                    height: 180px;
                    spacing: 20px;

                    // Meters
                    HorizontalLayout {
                        width: 60px;
                        spacing: 10px;
                        padding: 5px;
                        VerticalVU { label: "L"; value: root.mock_meter_l; }
                        VerticalVU { label: "R"; value: root.mock_meter_r; }
                    }

                    // Main Waveform
                    Rectangle {
                        horizontal-stretch: 1;
                        background: #111;
                        border-radius: 4px;
                        border-width: 2px;
                        border-color: #444;

                        // Mock Waveform
                        HorizontalLayout {
                            padding: 10px;
                            spacing: 2px;
                            alignment: center;
                            for val in root.mock_waveform : VerticalLayout {
                                alignment: center;
                                Rectangle {
                                    background: @linear-gradient(0deg, #7b1fa2 0%, #ba68c8 100%);
                                    width: 3px;
                                    height: Math.max(2px, val * parent.height * 0.9);
                                    border-radius: 1.5px;
                                }
                            }
                        }
                    }

                    // Right Side Actions
                    VerticalLayout {
                        width: 180px;
                        spacing: 10px;
                        HardwareButton { text: "RECORD TAPE"; bg: #4a148c; width: 180px; clicked => { root.action_triggered(self.text); } }
                        HardwareButton { text: "SAVE TAPE"; bg: #4a148c; width: 180px; clicked => { root.action_triggered(self.text); } }
                        HardwareButton { text: "LOAD TAPE"; bg: #4a148c; width: 180px; clicked => { root.action_triggered(self.text); } }
                    }
                }

                // BOTTOM CONTROLS GRID
                HorizontalLayout {
                    spacing: 40px;
                    padding: 20px;
                    
                    // Left Section: EQ / Filters
                    VerticalLayout {
                        spacing: 15px;
                        Text { text: "SOURCE 1"; color: white; font-weight: 800; }
                        Rectangle {
                            width: 80px; height: 200px;
                            border-width: 1px; border-color: white;
                            VerticalLayout {
                                alignment: space-around;
                                Knob { label: "TREBLE"; }
                                Knob { label: "BASS"; }
                            }
                        }
                    }

                    // Middle Section: Audio Mix
                    VerticalLayout {
                        spacing: 15px;
                        Text { text: "AUDIO"; color: white; font-weight: 800; horizontal-alignment: center; }
                        Rectangle {
                            width: 300px; height: 200px;
                            border-width: 1px; border-color: white;
                            VerticalLayout {
                                padding: 20px;
                                alignment: space-between;
                                HorizontalLayout {
                                    alignment: center;
                                    Knob { label: "FREQUENCY"; width: 100px; }
                                }
                                HorizontalLayout {
                                    alignment: space-between;
                                    Text { text: "BALANCE"; color: #aaa; }
                                    Text { text: "VOLUME"; color: #aaa; }
                                }
                            }
                        }
                    }

                    // Right Section: Tape Play
                    VerticalLayout {
                        spacing: 15px;
                        Text { text: "TAPE PLAY"; color: white; font-weight: 800; horizontal-alignment: center; }
                        Rectangle {
                            horizontal-stretch: 1; height: 200px;
                            border-width: 1px; border-color: white;
                            
                            HorizontalLayout {
                                padding: 30px;
                                spacing: 40px;
                                alignment: center;
                                Rectangle { width: 40px; height: 60px; background: #ff5252; border-radius: 4px; }
                                Rectangle { width: 40px; height: 60px; background: #00bcd4; border-radius: 4px; }
                                Knob { label: "COPY"; width: 80px; }
                            }
                        }
                    }
                }
            }
        }
    }
}
